name: ğŸ§ª Pipeline de Teste Ruby

# ğŸš€ Dispara o workflow quando houver push ou pull request na branch main
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: ğŸ”§ Build e Testes
    runs-on: ubuntu-latest  # Usa uma mÃ¡quina Ubuntu na nuvem

    steps:
      # ğŸ“¥ Baixa o cÃ³digo do repositÃ³rio
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v3

      # ğŸ› ï¸ Instala o Ruby via RVM (exemplo com Ruby 3.2.2)
      - name: ğŸ’ Instalar Ruby com RVM
        run: |
          sudo apt-get update
          sudo apt-get install software-properties-common -y
          sudo apt-add-repository -y ppa:rael-gc/rvm
          sudo apt-get update
          sudo apt-get install rvm -y
          source /etc/profile.d/rvm.sh
          rvm install 3.2.2
          rvm use 3.2.2 --default
          ruby --version

      # ğŸ’¾ Usa cache para acelerar instalaÃ§Ã£o de gems (evita downloads repetidos)
      - name: ğŸ’¾ Cache de dependÃªncias Ruby
        uses: actions/cache@v3
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      # ğŸ“¦ Instala o Bundler e as gems do projeto
      - name: ğŸ“¦ Instalar dependÃªncias com Bundler
        run: |
          gem install bundler
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      # ğŸ” Executa os testes com RSpec (ou troque por MiniTest, etc.)
      - name: ğŸ” Executar testes automatizados
        run: |
          bundle exec rspec --format documentation

      # âœ… Garante que o cÃ³digo segue padrÃµes de estilo com RuboCop
      - name: âœ… Verificar estilo de cÃ³digo com RuboCop
        run: |
          gem install rubocop
          rubocop || true  # Evita falha total por causa de estilo

      # ğŸ§ª Gera relatÃ³rio de cobertura de testes com SimpleCov
      - name: ğŸ§ª Gerar cobertura de testes
        run: |
          # Certifique-se de que seu projeto use SimpleCov
          echo "A cobertura serÃ¡ gerada na pasta coverage/"

      # ğŸ“¤ Salva logs e resultados da cobertura como artefatos
      - name: ğŸ“¤ Salvar logs e cobertura
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-de-testes
          path: |
            log/
            coverage/

      # ğŸ“£ Envia notificaÃ§Ã£o (exemplo usando Slack)
      # - name: ğŸ“£ Notificar no Slack
      #   uses: slackapi/slack-github-action@v1.23.0
      #   with:
      #     payload: |
      #       {
      #         "text": "ğŸš€ CI finalizado para ${{ github.repository }} â€“ Status: ${{ job.status }}"
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
